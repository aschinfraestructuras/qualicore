<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Upload Storage</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 20px 0; }
        .upload-area:hover { border-color: #007bff; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; }
        .success { color: green; }
        .error { color: red; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste Upload Storage Supabase</h1>
        
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <p>Clique aqui para selecionar um ficheiro</p>
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
        </div>
        
        <button onclick="testStorageConnection()">Testar Conex√£o Storage</button>
        <button onclick="clearLogs()">Limpar Logs</button>
        
        <div id="logs"></div>
    </div>

    <script>
        // Configura√ß√£o Supabase
        const supabaseUrl = "https://mjgvjpqcdsmvervcxjig.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qG3ZqcHFjZHNtdmVydmN4amlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0MDU1NDksImV4cCI6MjA2Nzk4MTU0OX0.dlsCn20Z9M71DGjnNeansnw--Kt8A3bdeIUbfYFpNqk";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logsDiv.appendChild(logDiv);
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testStorageConnection() {
            log('üîç Testando conex√£o com Storage...');
            
            try {
                // Verificar buckets
                const { data: buckets, error: bucketsError } = await supabase.storage.listBuckets();
                
                if (bucketsError) {
                    log(`‚ùå Erro ao listar buckets: ${bucketsError.message}`, 'error');
                    return;
                }
                
                log(`‚úÖ Buckets encontrados: ${buckets.length}`);
                buckets.forEach(bucket => {
                    log(`   - ${bucket.name} (${bucket.public ? 'P√∫blico' : 'Privado'})`);
                });
                
                // Verificar se bucket 'documents' existe
                const documentsBucket = buckets.find(b => b.name === 'documents');
                if (documentsBucket) {
                    log(`‚úÖ Bucket 'documents' encontrado (${documentsBucket.public ? 'P√∫blico' : 'Privado'})`);
                    
                    // Listar ficheiros no bucket
                    const { data: files, error: filesError } = await supabase.storage
                        .from('documents')
                        .list();
                    
                    if (filesError) {
                        log(`‚ùå Erro ao listar ficheiros: ${filesError.message}`, 'error');
                    } else {
                        log(`‚úÖ Ficheiros no bucket: ${files.length}`);
                        files.forEach(file => {
                            log(`   - ${file.name} (${file.metadata?.size || 'N/A'} bytes)`);
                        });
                    }
                } else {
                    log('‚ùå Bucket "documents" n√£o encontrado!', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro geral: ${error.message}`, 'error');
            }
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            log(`üìÅ Ficheiro selecionado: ${file.name} (${file.size} bytes)`);
            
            try {
                // Verificar autentica√ß√£o
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                
                if (authError) {
                    log(`‚ùå Erro de autentica√ß√£o: ${authError.message}`, 'error');
                    return;
                }
                
                if (!user) {
                    log('‚ö†Ô∏è Utilizador n√£o autenticado, tentando upload an√≥nimo...');
                } else {
                    log(`‚úÖ Utilizador autenticado: ${user.email}`);
                }
                
                // Gerar nome √∫nico
                const fileName = `test_${Date.now()}_${file.name}`;
                const filePath = `test/${fileName}`;
                
                log(`üì§ Fazendo upload para: ${filePath}`);
                
                // Upload
                const { data, error } = await supabase.storage
                    .from('documents')
                    .upload(filePath, file);
                
                if (error) {
                    log(`‚ùå Erro no upload: ${error.message}`, 'error');
                    return;
                }
                
                log(`‚úÖ Upload bem-sucedido: ${data.path}`);
                
                // Gerar URL p√∫blica
                const { data: urlData } = supabase.storage
                    .from('documents')
                    .getPublicUrl(filePath);
                
                log(`üîó URL p√∫blica: ${urlData.publicUrl}`);
                
                // Testar acesso √† URL
                try {
                    const response = await fetch(urlData.publicUrl);
                    if (response.ok) {
                        log('‚úÖ URL acess√≠vel - documento pode ser descarregado');
                    } else {
                        log(`‚ö†Ô∏è URL n√£o acess√≠vel - status: ${response.status}`, 'error');
                    }
                } catch (fetchError) {
                    log(`‚ùå Erro ao testar URL: ${fetchError.message}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro geral: ${error.message}`, 'error');
            }
        }

        // Testar conex√£o ao carregar a p√°gina
        window.onload = function() {
            log('üöÄ P√°gina carregada - iniciando teste...');
            testStorageConnection();
        };
    </script>
</body>
</html> 